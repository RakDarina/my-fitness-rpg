<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è | Fitness RPG</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        :root { 
            --primary: #6c5ce7; 
            --primary-light: #a29bfe;
            --bg: #f0f2f5; 
            --card-bg: #ffffff;
            --success: #00b894; 
            --danger: #d63031;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-main);
            margin: 0; 
            padding-top: 70px; 
            line-height: 1.6;
        }

        /* --- –®–ê–ü–ö–ê (–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è) --- */
        .header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; height: 65px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.04); z-index: 1000;
        }

        .site-title { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; flex: 1; }
        
        .nav { display: flex; gap: 5px; flex: 2; justify-content: center; }
        
        .nav-btn {
            border: none; background: none; color: var(--text-sub); font-weight: 600;
            padding: 8px 15px; cursor: pointer; border-radius: 12px; transition: all 0.2s;
            font-size: 0.9rem;
        }
        .nav-btn.active { background: var(--primary); color: white; }

        .header-right { flex: 1; text-align: right; }
        .star-counter { 
            background: #fff3cd; color: #856404; padding: 6px 12px; 
            border-radius: 50px; font-weight: 800; border: 1px solid #ffeeba;
        }

        /* --- –ö–û–ù–¢–ï–ù–¢ --- */
        .tab-content { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù (Desktop Grid) --- */
        .hero-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .hero-layout { grid-template-columns: 1fr; }
            .nav-btn { padding: 8px 10px; font-size: 0.8rem; }
            .site-title { display: none; } /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        }

        .hero-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .hero-img { max-width: 100%; height: 320px; object-fit: contain; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }

        .stats-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            border: 1px solid #edf2f7;
        }

        .stat-label { display: block; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px; }
        .stat-value { font-weight: 700; color: var(--text-main); }

        /* --- –ö–ê–†–¢–û–ß–ö–ò –ò –°–ü–ò–°–ö–ò --- */
        .item-card { 
            background: var(--card-bg); padding: 18px; margin-bottom: 12px; 
            border-radius: 18px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
        }

        /* --- –ö–ê–õ–ï–ù–î–ê–†–¨ --- */
        .calendar-wrapper { background: white; padding: 20px; border-radius: 24px; box-shadow: var(--shadow); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; background: #f8f9fa; font-weight: 600; font-size: 0.9rem;
            border: 1px solid transparent;
        }
        .day.completed { background: #d1fae5; color: var(--success); border-color: #34d399; }

        /* --- –ö–ù–û–ü–ö–ò --- */
        .btn { 
            border: none; padding: 14px 20px; border-radius: 16px; color: white; 
            cursor: pointer; font-weight: 700; transition: transform 0.1s, opacity 0.2s; 
            font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-add { background: var(--primary); width: 100%; }
        .btn-undo { background: #fee2e2; color: var(--danger); }
        .btn-success { background: var(--success); color: white; width: 100%; }

        /* --- –ú–û–î–ê–õ–ö–ò --- */
        .modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; 
            padding: 20px;
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 28px; width: 100%; max-width: 450px; 
            max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .modal-content input { 
            width: 100%; margin-bottom: 15px; padding: 14px; border: 2px solid #f1f2f6; 
            border-radius: 12px; font-size: 1rem; outline: none; transition: border-color 0.2s;
        }
        .modal-content input:focus { border-color: var(--primary-light); }

        hr { border: none; border-top: 1px solid #eee; margin: 25px 0; }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ò (–ù–æ–≤–æ–µ) */
        .ai-header-card { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; text-align: left; align-items: flex-start; }
        .ai-progress-bg { width: 100%; height: 12px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .ai-progress-fill { height: 100%; background: #00b894; width: 0%; transition: width 0.5s ease; }
    </style>
</head>
<body>

    <header class="header">
        <div class="site-title">Fitness RPG</div>
        <nav class="nav">
            <button class="nav-btn active" data-tab="tab-data">–î–∞–Ω–Ω—ã–µ</button>
            <button class="nav-btn" data-tab="tab-tasks">–ó–∞–¥–∞–Ω–∏—è</button>
            <button class="nav-btn" data-tab="tab-ai">ü§ñ –ò–ò</button> <button class="nav-btn" data-tab="tab-shop">–ú–∞–≥–∞–∑–∏–Ω</button>
        </nav>
        <div class="header-right">
            <div class="star-counter">‚≠êÔ∏è <span id="starDisplay">0</span></div>
        </div>
    </header>

    <div id="tab-data" class="tab-content active">
        <div class="hero-layout">
            <div class="hero-card">
                <img id="characterImage" src="stage1.png" alt="–ì–µ—Ä–æ–π" class="hero-img">
            </div>
            <div class="hero-card">
                <h3 style="margin-top:0; width:100%">–¢–µ–∫—É—â–∏–µ –∑–∞–º–µ—Ä—ã</h3>
                <div class="stats-list" id="currentStats">
                    <div style="grid-column: 1/-1; color: var(--text-sub);">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; width:100%; margin-top:25px;">
                    <button class="btn btn-add" id="openAddStats">‚ûï –ó–∞–º–µ—Ä</button>
                    <button class="btn" style="background:#edf2f7; color:var(--text-main);" id="openHistory">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-ai" class="tab-content">
        <div class="hero-card ai-header-card">
            <h2 style="margin:0;">ü§ñ –ò–ò-–ù–∞—Å—Ç–∞–≤–Ω–∏–∫</h2>
            <div id="ai-prediction" style="font-size: 1.1rem; font-weight: bold; margin-top: 10px;">
                –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...
            </div>
            <div id="ai-days-left" style="font-size: 0.9rem; opacity: 0.9;">
                –°–¥–µ–ª–∞–π –∑–∞–º–µ—Ä—ã, —á—Ç–æ–±—ã —è —Å–æ—Å—Ç–∞–≤–∏–ª –ø—Ä–æ–≥–Ω–æ–∑.
            </div>
            <div class="ai-progress-bg">
                <div id="ai-progress-fill" class="ai-progress-fill"></div>
            </div>
            <div id="ai-achievement" style="margin-top:15px; background:rgba(255,255,255,0.2); padding:5px 12px; border-radius:10px; font-size:0.85rem;">
                üéñ –†–∞–Ω–≥: –ù–æ–≤–∏—á–æ–∫
            </div>
        </div>

        <div class="hero-layout" style="margin-top: 25px;">
            <div class="hero-card" style="align-items: flex-start;">
                <h4 style="margin: 0 0 15px 0; color: var(--primary);">üéØ –¢–≤–æ—è —Ü–µ–ª—å</h4>
                <div style="width: 100%; display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="number" id="targetWeightInput" placeholder="–¶–µ–ª—å (–∫–≥)" style="margin:0; padding: 10px; width: 60%;">
                    <button class="btn btn-add" onclick="runAIAnalysis()" style="width:auto; padding: 10px 20px;">–û–∫</button>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-sub);">–í–≤–µ–¥–∏ –∂–µ–ª–∞–µ–º—ã–π –≤–µ—Å, –∏ —è —Ä–∞—Å—Å—á–∏—Ç–∞—é –¥–∞—Ç—É —É—Å–ø–µ—Ö–∞.</p>
            </div>
            
            <div class="hero-card" style="align-items: flex-start;">
                <h4 style="margin: 0 0 15px 0; color: var(--success);">üìã –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h4>
                <div id="ai-plan-text" style="font-size: 0.9rem; color: var(--text-sub); width: 100%;">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞...
                </div>
            </div>
        </div>

        <div class="hero-card" style="align-items: flex-start; background: #fff8e1; border: 1px solid #ffe082;">
            <h4 style="margin: 0 0 10px 0; color: #f39c12;">üí° –£–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</h4>
            <div id="ai-tip" style="font-style: italic; color: var(--text-main);">
                "–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –ø–æ–±–µ–¥–∞–º."
            </div>
        </div>
    </div>
    <div id="tab-tasks" class="tab-content">
        <div class="calendar-wrapper">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button id="prevMonth" style="border:none; background:#f1f2f6; border-radius:10px; padding:5px 12px; cursor:pointer;">‚Üê</button>
                <span id="monthYear" style="font-weight:800; font-size: 1.2rem;"></span>
                <button id="nextMonth" style="border:none; background:#f1f2f6; border-radius:10px; padding:5px 12px; cursor:pointer;">‚Üí</button>
            </div>
            <div style="text-align:center; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-sub);">1 —á–∞—Å –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ = 1 ‚≠êÔ∏è</div>
            <div class="calendar-grid" id="calendar"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:25px;">
                <button class="btn btn-success" id="doTask">‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                <button class="btn btn-undo" id="undoTask" style="font-size: 0.9rem;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <h3 style="margin: 35px 0 15px;">üéØ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏</h3>
        <div id="goalsList"></div>
        <button class="btn btn-add" id="openAddGoal" style="background: var(--primary-light);">‚ûï –ù–æ–≤–∞—è —Ü–µ–ª—å</button>

        <div style="margin-top:40px; padding: 25px; background: #fff5f5; border-radius: 24px; border: 1px solid #fed7d7;">
            <h4 style="margin:0 0 10px; color:#c53030;">üçü –§–∞—Å—Ç—Ñ—É–¥ (–ù–∞–∫–∞–∑–∞–Ω–∏–µ)</h4>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-undo" id="btnFastFood" style="flex:2; background:#feb2b2; color:#9b2c2c;">–°—ä–µ–ª–∞ (-1 ‚≠êÔ∏è)</button>
                <button class="btn" id="btnNoFastFood" style="flex:1; background:white; color:var(--text-sub); border:1px solid #cbd5e0;">–û—à–∏–±–∫–∞</button>
            </div>
        </div>
    </div>

    <div id="tab-shop" class="tab-content">
        <h3 style="margin-top:0;">üõí –ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥</h3>
        <div id="shopList"></div>
        <button class="btn btn-add" id="openAddItem" style="margin-bottom:30px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        
        <h3 style="border-top:1px solid #eee; pt:20px;">üéí –ú–æ–π —Ä—é–∫–∑–∞–∫</h3>
        <div id="inventoryList"></div>
    </div>

    <div id="addStatsModal" class="modal"><div class="modal-content"><form id="statsForm"><h3>–ù–æ–≤—ã–π –∑–∞–º–µ—Ä</h3><input type="number" step="0.1" name="weight" placeholder="–í–µ—Å (–∫–≥)" required><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><input type="number" step="0.1" name="fat" placeholder="–ñ–∏—Ä %"><input type="number" step="0.1" name="protein" placeholder="–ë–µ–ª–æ–∫"><input type="number" step="0.1" name="water" placeholder="–í–æ–¥–∞"><input type="number" step="0.1" name="waist" placeholder="–¢–∞–ª–∏—è —Å–º"><input type="number" step="0.1" name="chest" placeholder="–ì—Ä—É–¥—å —Å–º"><input type="number" step="0.1" name="hips" placeholder="–ë–µ–¥—Ä–∞ —Å–º"></div><button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button type="button" class="btn btn-undo close-modal" style="margin-top:10px; width:100%">–û—Ç–º–µ–Ω–∞</button></form></div></div>

    <div id="addGoalModal" class="modal"><div class="modal-content"><form id="goalForm"><h3>–ù–æ–≤–∞—è —Ü–µ–ª—å</h3><input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏" required><input type="number" name="reward" placeholder="–ù–∞–≥—Ä–∞–¥–∞ (–∑–≤–µ–∑–¥)" required><button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å</button><button type="button" class="btn btn-undo close-modal" style="margin-top:10px; width:100%">–û—Ç–º–µ–Ω–∞</button></form></div></div>

    <div id="addItemModal" class="modal"><div class="modal-content"><form id="itemForm"><h3 id="itemModalTitle">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3><input type="hidden" name="id"><input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required><input type="number" name="price" placeholder="–¶–µ–Ω–∞ (–∑–≤–µ–∑–¥)" required><input type="url" name="link" placeholder="–°—Å—ã–ª–∫–∞ üîó"><input type="text" name="imgUrl" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ üñº"><button type="submit" class="btn btn-success" id="itemSubmitBtn">–î–æ–±–∞–≤–∏—Ç—å</button><button type="button" class="btn btn-undo close-modal" style="margin-top:10px; width:100%">–û—Ç–º–µ–Ω–∞</button></form></div></div>

    <div id="historyModal" class="modal"><div class="modal-content"><h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</h3><div id="historyList"></div><button class="btn btn-undo close-modal" style="width:100%; margin-top:15px;">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var state = JSON.parse(localStorage.getItem('fitness_rpg_v5')) || {
                stars: 0, stats: [], completedDates: [], shop: [], inventory: [], goals: []
            };
            if (!state.goals) state.goals = [];
            if (!state.shop) state.shop = [];
            if (!state.inventory) state.inventory = [];

            var save = function() {
                localStorage.setItem('fitness_rpg_v5', JSON.stringify(state));
                document.getElementById('starDisplay').innerText = state.stars;
            };

            var closeModal = function() { document.querySelectorAll('.modal').forEach(function(m) { m.style.display = 'none'; }); };
            var openModal = function(id) { document.getElementById(id).style.display = 'flex'; };

            var updateCharacter = function(weight) {
                var imgElement = document.getElementById('characterImage');
                if (!imgElement) return;
                var stage = "stage1.png";
                var w = parseFloat(weight);
                if (w >= 68) stage = "stage6.png";
                else if (w >= 65) stage = "stage5.png";
                else if (w >= 62) stage = "stage4.png";
                else if (w >= 59) stage = "stage3.png";
                else if (w >= 56) stage = "stage2.png";
                else stage = "stage1.png";
                imgElement.src = stage;
            };

            document.querySelectorAll('.nav-btn').forEach(function(btn) {
                btn.onclick = function() {
                    document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
                    document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
                    document.getElementById(btn.getAttribute('data-tab')).classList.add('active');
                    btn.classList.add('active');
                    if (btn.getAttribute('data-tab') === 'tab-tasks') renderCalendar();
                    if (btn.getAttribute('data-tab') === 'tab-shop') renderShop();
                    if (btn.getAttribute('data-tab') === 'tab-ai') runAIAnalysis(); // –î–û–ë–ê–í–õ–ï–ù–û
                };
            });

            document.getElementById('openAddStats').onclick = function() { openModal('addStatsModal'); };
            document.getElementById('openHistory').onclick = function() { renderHistory(); openModal('historyModal'); };
            document.querySelectorAll('.close-modal').forEach(function(b) { b.onclick = closeModal; });

            document.getElementById('statsForm').onsubmit = function(e) {
                e.preventDefault();
                state.stats.push({
                    id: Date.now(), date: new Date().toLocaleDateString(),
                    weight: e.target.weight.value, fat: e.target.fat.value,
                    protein: e.target.protein.value, water: e.target.water.value,
                    waist: e.target.waist.value, chest: e.target.chest.value,
                    hips: e.target.hips.value
                });
                save(); renderStats(); closeModal(); e.target.reset();
            };

            var renderStats = function() {
                var last = state.stats[state.stats.length - 1];
                var container = document.getElementById('currentStats');
                if (!last) return;
                
                var html = `<div style="grid-column: 1/-1; font-size: 0.8rem; color: var(--text-sub); margin-bottom:10px;">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${last.date}</div>`;
                const fields = [
                    {l: '–í–µ—Å', v: last.weight, u: '–∫–≥'}, {l: '–ñ–∏—Ä', v: last.fat, u: '%'},
                    {l: '–ë–µ–ª–æ–∫', v: last.protein, u: ''}, {l: '–í–æ–¥–∞', v: last.water, u: ''},
                    {l: '–¢–∞–ª–∏—è', v: last.waist, u: '—Å–º'}, {l: '–ì—Ä—É–¥—å', v: last.chest, u: '—Å–º'},
                    {l: '–ë–µ–¥—Ä–∞', v: last.hips, u: '—Å–º'}
                ];
                
                fields.forEach(f => {
                    if(f.v) html += `<div class="stat-item"><span class="stat-label">${f.l}</span><span class="stat-value">${f.v} ${f.u}</span></div>`;
                });
                container.innerHTML = html;
                updateCharacter(last.weight);
            };

            var renderHistory = function() {
                var hList = document.getElementById('historyList'); hList.innerHTML = '';
                state.stats.slice().reverse().forEach(function(s) {
                    hList.innerHTML += `<div class="item-card" style="flex-direction: column; align-items: flex-start;">
                        <div style="width:100%"><button style="background:var(--danger); color:white; border:none; padding:4px 8px; border-radius:8px; float:right; cursor:pointer; font-size:10px;" onclick="window.deleteStat(${s.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        <b>${s.date}</b></div>
                        <div style="font-size: 12px; color:var(--text-sub);">–í–µ—Å: ${s.weight}–∫–≥ | –¢–∞–ª–∏—è: ${s.waist}—Å–º</div></div>`;
                });
            };
            window.deleteStat = function(id) { state.stats = state.stats.filter(function(s) { return s.id !== id; }); save(); renderStats(); renderHistory(); };

            var currDate = new Date();
            var renderCalendar = function() {
                var grid = document.getElementById('calendar'); grid.innerHTML = '';
                var m = currDate.getMonth(), y = currDate.getFullYear();
                var monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
                document.getElementById('monthYear').innerText = monthNames[m] + ' ' + y;
                var days = new Date(y, m + 1, 0).getDate();
                for (var i = 1; i <= days; i++) {
                    var d = document.createElement('div'); d.className = 'day';
                    var key = y + '-' + m + '-' + i;
                    if (state.completedDates.indexOf(key) !== -1) d.classList.add('completed');
                    d.innerText = i; grid.appendChild(d);
                }
            };
            document.getElementById('prevMonth').onclick = function() { currDate.setMonth(currDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = function() { currDate.setMonth(currDate.getMonth() + 1); renderCalendar(); };
            document.getElementById('doTask').onclick = function() {
                var d = new Date(), key = d.getFullYear() + '-' + d.getMonth() + '-' + d.getDate();
                if (state.completedDates.indexOf(key) === -1) { state.completedDates.push(key); state.stars += 1; save(); renderCalendar(); }
                else { alert("–°–µ–≥–æ–¥–Ω—è —É–∂–µ –æ—Ç–º–µ—á–µ–Ω–æ!"); }
            };
            document.getElementById('undoTask').onclick = function() {
                var d = new Date(), key = d.getFullYear() + '-' + d.getMonth() + '-' + d.getDate();
                if (state.completedDates.indexOf(key) !== -1) { state.completedDates = state.completedDates.filter(function(k) { return k !== key; }); state.stars -= 1; save(); renderCalendar(); }
            };

            // –ú–ê–ì–ê–ó–ò–ù
            document.getElementById('openAddItem').onclick = function() {
                document.getElementById('itemModalTitle').innerText = "–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä";
                document.getElementById('itemForm').reset();
                document.getElementById('itemForm').id.value = "";
                openModal('addItemModal');
            };

            document.getElementById('itemForm').onsubmit = function(e) {
                e.preventDefault();
                var id = e.target.id.value;
                var itemData = {
                    id: id ? parseInt(id) : Date.now(),
                    name: e.target.name.value, price: parseInt(e.target.price.value),
                    link: e.target.link.value, imgUrl: e.target.imgUrl.value
                };
                if (id) {
                    var idx = state.shop.findIndex(function(i) { return i.id === parseInt(id); });
                    state.shop[idx] = itemData;
                } else { state.shop.push(itemData); }
                save(); renderShop(); closeModal();
            };

            window.buyItem = function(id) {
                var idx = state.shop.findIndex(function(i) { return i.id === id; });
                var item = state.shop[idx];
                if (state.stars >= item.price) {
                    state.stars -= item.price; state.inventory.push(item); state.shop.splice(idx, 1);
                    save(); renderShop();
                } else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!"); }
            };
            
            window.renderShop = function() {
                var sList = document.getElementById('shopList'), iList = document.getElementById('inventoryList');
                sList.innerHTML = '';
                state.shop.forEach(function(item) {
                    sList.innerHTML += `<div class="item-card">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:50px; height:50px; background:#f1f2f6; border-radius:10px; overflow:hidden;">
                                ${item.imgUrl ? `<img src="${item.imgUrl}" style="width:100%; height:100%; object-fit:cover;">` : ''}
                            </div>
                            <div><b>${item.name}</b><br><small style="color:var(--success)">${item.price} ‚≠êÔ∏è</small></div>
                        </div>
                        <button class="btn btn-add" style="width:auto; padding:6px 12px; font-size:12px;" onclick="window.buyItem(${item.id})">–í–∑—è—Ç—å</button>
                    </div>`;
                });
                iList.innerHTML = '';
                state.inventory.forEach(function(item) {
                    iList.innerHTML += `<div class="item-card"><span>${item.name}</span><button class="btn btn-undo" style="width:auto; padding:5px 10px; font-size:12px;" onclick="window.returnItem(${item.id})">–í–µ—Ä–Ω—É—Ç—å</button></div>`;
                });
            };
            window.returnItem = function(id) {
                var idx = state.inventory.findIndex(function(i) { return i.id === id; });
                var item = state.inventory[idx];
                state.stars += item.price; state.shop.push(item); state.inventory.splice(idx, 1);
                save(); renderShop();
            };

            // –¶–ï–õ–ò
            document.getElementById('openAddGoal').onclick = function() { openModal('addGoalModal'); };
            document.getElementById('goalForm').onsubmit = function(e) {
                e.preventDefault();
                state.goals.push({ id: Date.now(), name: e.target.name.value, reward: parseInt(e.target.reward.value) });
                save(); renderGoals(); closeModal(); e.target.reset();
            };
            window.renderGoals = function() {
                var gList = document.getElementById('goalsList'); gList.innerHTML = '';
                state.goals.forEach(function(g) {
                    gList.innerHTML += `<div class="item-card">
                        <div><b>${g.name}</b> <span style="color:var(--success); ml:10px;">+${g.reward}‚≠êÔ∏è</span></div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="window.completeGoal(${g.id})" class="btn btn-success" style="width:40px; padding:0; height:40px;">‚úì</button>
                            <button onclick="window.deleteGoal(${g.id})" class="btn btn-undo" style="width:40px; padding:0; height:40px;">üóë</button>
                        </div>
                    </div>`;
                });
            };
            window.completeGoal = function(id) {
                var goal = state.goals.find(function(g) { return g.id === id; });
                if (goal) { state.stars += goal.reward; state.goals = state.goals.filter(function(g) { return g.id !== id; }); save(); renderGoals(); }
            };
            window.deleteGoal = function(id) { state.goals = state.goals.filter(function(g) { return g.id !== id; }); save(); renderGoals(); };

            document.getElementById('btnFastFood').onclick = function() { state.stars -= 1; save(); };
            document.getElementById('btnNoFastFood').onclick = function() { state.stars += 1; save(); };
            
            // --- –õ–û–ì–ò–ö–ê –ò–ò (–ù–û–í–ê–Ø) ---
            window.runAIAnalysis = function() {
                var savedTarget = localStorage.getItem('ai_target_weight') || 55;
                document.getElementById('targetWeightInput').value = savedTarget;
                
                var last = state.stats[state.stats.length - 1];
                var aiPredict = document.getElementById('ai-prediction');
                var aiDays = document.getElementById('ai-days-left');
                var aiFill = document.getElementById('ai-progress-fill');
                
                if (!last) {
                    aiPredict.innerText = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞";
                    aiDays.innerText = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä –≤–µ—Å–∞ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–î–∞–Ω–Ω—ã–µ¬ª.";
                    return;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–ª—å
                var inputVal = document.getElementById('targetWeightInput').value;
                if(inputVal) {
                    localStorage.setItem('ai_target_weight', inputVal);
                    savedTarget = inputVal;
                }
                
                var currentW = parseFloat(last.weight);
                var targetW = parseFloat(savedTarget);
                
                // –ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –∏ –≤–æ–¥—ã
                var calories = Math.round(currentW * 24 * 1.2);
                document.getElementById('ai-plan-text').innerHTML = `
                    <ul style="padding-left:20px; margin:0;">
                        <li>üíß –í–æ–¥–∞: <b>${(currentW * 0.033).toFixed(1)} –ª</b></li>
                        <li>ü•© –ë–µ–ª–æ–∫: <b>${(currentW * 1.5).toFixed(0)} –≥</b></li>
                        <li>üî• –ö–∞–ª–æ—Ä–∏–∏: <b>${calories - 300} - ${calories} –∫–∫–∞–ª</b></li>
                    </ul>
                `;
                
                // –ê—á–∏–≤–∫–∏
                var rank = "–ù–æ–≤–∏—á–æ–∫";
                if(state.stars > 20) rank = "–ë—ã–≤–∞–ª—ã–π –ê—Ç–ª–µ—Ç";
                if(state.stars > 50) rank = "–õ–µ–≥–µ–Ω–¥–∞ –§–∏—Ç–Ω–µ—Å–∞";
                document.getElementById('ai-achievement').innerText = "üéñ –†–∞–Ω–≥: " + rank;
                
                // –£–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–ü–ª–∞—Ç–æ)
                var tipText = "–°–æ–Ω ‚Äî —ç—Ç–æ –ª—É—á—à–∏–π –∂–∏—Ä–æ—Å–∂–∏–≥–∞—Ç–µ–ª—å. –°–ø–∏ 8 —á–∞—Å–æ–≤.";
                if(state.stats.length >= 3) {
                   var recent = state.stats.slice(-3);
                   var diff = Math.abs(parseFloat(recent[recent.length-1].weight) - parseFloat(recent[0].weight));
                   if(diff < 0.3) tipText = "‚ö†Ô∏è –ö–∞–∂–µ—Ç—Å—è, –≤–µ—Å –≤—Å—Ç–∞–ª (–ü–ª–∞—Ç–æ). –£—Å—Ç—Ä–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å 200 –∫–∫–∞–ª, —á—Ç–æ–±—ã —Ä–∞–∑–æ–≥–Ω–∞—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º.";
                   else tipText = "üî• –û—Ç–ª–∏—á–Ω—ã–π —Ç–µ–º–ø! –ñ–∏—Ä –ø–ª–∞–≤–∏—Ç—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∞–π –ø–∏—Ç—å –≤–æ–¥—É.";
                }
                document.getElementById('ai-tip').innerHTML = "<i>" + tipText + "</i>";

                // –ü—Ä–æ–≥–Ω–æ–∑ –¥–∞—Ç—ã
                if (state.stats.length >= 2) {
                    var first = state.stats[0];
                    var totalDiff = parseFloat(first.weight) - currentW;
                    var daysDiff = (last.id - first.id) / (1000 * 60 * 60 * 24);
                    
                    if (totalDiff > 0.1 && daysDiff > 0.5) {
                        var speed = totalDiff / daysDiff; // –∫–≥ –≤ –¥–µ–Ω—å
                        var left = currentW - targetW;
                        var daysNeeded = Math.round(left / speed);
                        
                        if(daysNeeded > 0) {
                            var date = new Date();
                            date.setDate(date.getDate() + daysNeeded);
                            aiPredict.innerText = "–¶–µ–ª—å: " + date.toLocaleDateString('ru-RU', {day:'numeric', month:'long'});
                            aiDays.innerText = `–û—Å—Ç–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å ${left.toFixed(1)} –∫–≥ (–ø—Ä–∏–º–µ—Ä–Ω–æ ${daysNeeded} –¥–Ω.)`;
                            
                            // –®–∫–∞–ª–∞
                            var totalToLose = parseFloat(first.weight) - targetW;
                            var percent = ((parseFloat(first.weight) - currentW) / totalToLose) * 100;
                            aiFill.style.width = Math.min(100, Math.max(5, percent)) + "%";
                            return;
                        }
                    }
                }
                
                aiPredict.innerText = "–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...";
                aiDays.innerText = "–ú–Ω–µ –Ω—É–∂–Ω–æ –µ—â–µ –ø–∞—Ä—É –¥–Ω–µ–π –∑–∞–º–µ—Ä–æ–≤, —á—Ç–æ–±—ã —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–æ—á–Ω—É—é –¥–∞—Ç—É.";
                aiFill.style.width = "5%";
            };

            save(); renderStats(); renderShop(); renderGoals();
        });
    </script>
</body>
</html>
